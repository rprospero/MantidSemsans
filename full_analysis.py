"""

This module provides helper functions for automatinc the semsans
analysis.  The most important function from the user perspective is
analyse.

"""

from os.path import join, exists, dirname
import sans.command_interface.ISISCommandInterface as ici
from mantid.api import mtd
from mantid.simpleapi import DeleteWorkspaces
from .Semsans import int3samples, norm, sel
from .runtypes import table_to_run


def get_shimed(run, path, refresh=False):
    """

    Gives the path for the detector image for a run with both spin
    states merged.  If the spin state combination has already been
    performed, then the file path is immediately returned.  If the
    file does not already exist, then it can be created.

    Parameters
    ----------
    run
      The run number whose detector image is being requested
    path
      The folder where the detector images should be saved
    reload
      Whether to always recreate the shimmed file.  The default is False

    Return
    ------
    A string containing the location of the shimmed file

    """
    f = join(path, "LARMOR{:08d}-add.nxs".format(run))
    if refresh or not exists(f):
        wksp = SumToShim(run)
        SaveNexusProcessed(wksp, f)
        DeleteWorkspace(wksp)
    return f


def analyse(data_table, masks, output_file,
            show_fits=False, show_quality=False):
    """

    Analyse a set of combined Sans and Semsans measurements.
    The result will be a set of workspaces with the Semsans data
    and a csv file that can be loaded into the batch sans interface
    to load the sans data.

    Parameters
    ----------
    data_table
      The name of WorkspaceTable with the runs that need to be analysed.  This
      table should be generated by the get_log function.
    masks
      A list of strings containing the filenames of the masks for the
      individual tubes used in the semsans polarisation calculation
    output_file
      Where to save the CSV file that will generate the SANS runs
    show_fits
      Whether to show the individual tube fits used to calculate the spin echo
      length.  Defaults to False
    show_quality
      Whether to show the quality of the linear fit of the precession
      frequencies used to calculate the spin echo length.  Defaults to False

    """
    if "Full_Blank" not in mtd.getObjectNames():
        int3samples(table_to_run(mtd["metadata_Full_Blank_runs"]), "Full_Blank", masks)
    const = SelConst(mtd["Full_Blank_39"], mtd["Full_Blank_40"],
                     mtd["Full_Blank_41"])

    k = data_table[9:-5]
    runs = table_to_run(mtd[data_table])
    for run in runs:
        get_shimed(run.number, dirname(output_file))
        get_shimed(run.trans, dirname(output_file))
        get_shimed(run.csans, dirname(output_file))
        get_shimed(run.ctrans, dirname(output_file))
        get_shimed(run.direct, dirname(output_file))
        semsans_ws = "{}_hours_{:0.02f}".format(k, (run.start-runs[0].start).seconds/3600.0)
        int3samples([run], semsans_ws, masks)
        # DeleteWorkspace("{}_sans_nxs".format(run.number))
        norm(semsans_ws, "Full_Blank", masks)
        wtemp = Patterson(pol=semsans_ws+"_norm", const=const)
        RenameWorkspace(wtemp, semsans_ws+"_sel")
        DeleteWorkspaces([semsans_ws,
                          semsans_ws+"_Norm"])
    with open(output_file, "w") as outfile:
        framework = "sample_sans,{}-add," \
                    "sample_trans,{}-add," \
                    "sample_direct_beam,{}-add,"\
                    "can_sans,{}-add,"\
                    "can_trans,{}-add,"\
                    "can_direct_beam,{}-add,"\
                    "output_as,{}_hours_{:0.2f}\n"
        for idx, run in enumerate(runs):
            outfile.write(
                framework.format(run.number, run.trans, run.direct,
                                 run.csans, run.ctrans, run.direct, k,
                                 (run.start-runs[0].start).seconds/3600.0))

    import sans.command_interface.ISISCommandInterface as ici
    ici.Clean()
    ici.LARMOR()
    ici.MaskFile(r"\\isis\inst$\NDXLARMOR\User\Users\Masks\USER_Edler_171B_a2_8mm_SEMSANS_r20287.txt")
    ici.BatchReduce(output_file, format=".nxs", verbose=True)
